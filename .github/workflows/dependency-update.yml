name: Dependency Update Check

on:
  schedule:
    - cron: '0 0 * * 0' # Weekly on Sunday
  workflow_dispatch:

jobs:
  check-updates:
    name: Check for Dependency Updates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check npm outdated (Frontend)
        working-directory: ./frontend
        run: |
          npm outdated || echo "Some packages have updates available"
        continue-on-error: true

      - name: Check npm outdated (Node.js Services)
        working-directory: ./backend/api-gateway
        run: |
          npm outdated || echo "Some packages have updates available"
        continue-on-error: true

      - name: Check Maven dependency updates (Java Services)
        working-directory: ./backend/services/auth-service
        run: |
          mvn versions:display-dependency-updates || echo "Maven dependency check completed"
        continue-on-error: true

      - name: Create issue for major updates
        uses: actions/github-script@v7
        if: failure()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const title = 'ðŸ”” Dependency Updates Available';
            const body = `Automated dependency check found updates. Please review and update dependencies when ready.`;

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'dependencies'
            });

            if (issues.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['dependencies', 'automated']
              });
            }
