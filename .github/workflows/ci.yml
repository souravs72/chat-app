name: CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
  workflow_dispatch:

env:
  NODE_VERSION: "18"
  JAVA_VERSION: "17"

jobs:
  # Frontend - Lint, Build, and Type Check
  frontend:
    name: Frontend (React/TypeScript)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for package-lock.json
        id: check_lockfile
        run: |
          if [ -f "package-lock.json" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js (with cache)
        if: steps.check_lockfile.outputs.exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Setup Node.js (without cache)
        if: steps.check_lockfile.outputs.exists == 'false'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          if [ -f "package-lock.json" ]; then
            npm ci
          else
            npm install
            echo "⚠️ package-lock.json not found, dependencies installed without lock file"
          fi

      - name: Lint
        run: npm run lint
        continue-on-error: true

      - name: Type check
        run: npx tsc --noEmit
        timeout-minutes: 5

      - name: Build
        run: npm run build
        timeout-minutes: 10

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist/
          retention-days: 1
        if: success()

  # Node.js Services - API Gateway, Chat, Media, Story
  nodejs-services:
    name: Node.js Services - ${{ matrix.service }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - service: api-gateway
            path: backend/api-gateway
            has_lockfile: true
            lockfile: backend/api-gateway/package-lock.json
          - service: chat-service
            path: backend/services/chat-service
            has_lockfile: false
          - service: media-service
            path: backend/services/media-service
            has_lockfile: false
          - service: story-service
            path: backend/services/story-service
            has_lockfile: false
    defaults:
      run:
        working-directory: ./${{ matrix.path }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js (with cache)
        if: matrix.has_lockfile == true
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: ${{ matrix.lockfile }}

      - name: Setup Node.js (without cache)
        if: matrix.has_lockfile == false
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          if [ -f "package-lock.json" ]; then
            npm ci
          else
            npm install
            echo "⚠️ package-lock.json not found for ${{ matrix.service }}, dependencies installed without lock file"
          fi

      - name: Syntax check
        run: |
          if [ -f "src/index.js" ]; then
            node --check src/index.js || echo "No JavaScript files to check"
          fi
        continue-on-error: true

  # Java Services - Auth, User, Notification
  java-services:
    name: Java Service - ${{ matrix.service }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service:
          - auth-service
          - user-service
          - notification-service
    defaults:
      run:
        working-directory: ./backend/services/${{ matrix.service }}

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: testdb
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: "temurin"
          cache: "maven"
          cache-dependency-path: backend/services/${{ matrix.service }}/pom.xml

      - name: Run Maven tests
        run: mvn clean test
        timeout-minutes: 15
        env:
          SPRING_PROFILES_ACTIVE: test
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: testdb
          DB_USER: postgres
          DB_PASSWORD: postgres

      - name: Build JAR
        run: mvn clean package -DskipTests
        timeout-minutes: 10

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: jar-${{ matrix.service }}
          path: backend/services/${{ matrix.service }}/target/*.jar
          retention-days: 1
        continue-on-error: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.service }}
          path: backend/services/${{ matrix.service }}/target/surefire-reports/
          retention-days: 7
        continue-on-error: true

  # Docker Build Verification
  docker-build:
    name: Docker Build - ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: [frontend, nodejs-services, java-services]
    strategy:
      fail-fast: false
      matrix:
        include:
          - service: frontend
            context: ./frontend
          - service: api-gateway
            context: ./backend/api-gateway
          - service: auth-service
            context: ./backend/services/auth-service
          - service: user-service
            context: ./backend/services/user-service
          - service: chat-service
            context: ./backend/services/chat-service
          - service: media-service
            context: ./backend/services/media-service
          - service: story-service
            context: ./backend/services/story-service
          - service: notification-service
            context: ./backend/services/notification-service

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          push: false
          tags: chat-platform/${{ matrix.service }}:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
        timeout-minutes: 15

  # Integration Test (optional - runs docker-compose build)
  integration-test:
    name: Integration Test
    runs-on: ubuntu-latest
    needs: [docker-build]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker Compose Build
        run: docker compose -f docker-compose.yml config

      - name: Build all services
        run: |
          docker compose -f docker-compose.yml build --parallel
        timeout-minutes: 30

  # Summary job that depends on all others
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [frontend, nodejs-services, java-services, docker-build]
    if: always()

    steps:
      - name: Check all jobs
        run: |
          if [ "${{ needs.frontend.result }}" != "success" ] || \
             [ "${{ needs.nodejs-services.result }}" != "success" ] || \
             [ "${{ needs.java-services.result }}" != "success" ] || \
             [ "${{ needs.docker-build.result }}" != "success" ]; then
            echo "❌ One or more CI jobs failed"
            echo "Frontend: ${{ needs.frontend.result }}"
            echo "Node.js Services: ${{ needs.nodejs-services.result }}"
            echo "Java Services: ${{ needs.java-services.result }}"
            echo "Docker Build: ${{ needs.docker-build.result }}"
            exit 1
          fi
          echo "✅ All CI checks passed successfully!"

      - name: Summary
        run: |
          echo "## CI Pipeline Status ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.frontend.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Node.js Services | ${{ needs.nodejs-services.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Java Services | ${{ needs.java-services.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Builds | ${{ needs.docker-build.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
