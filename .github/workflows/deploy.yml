name: Deploy

on:
  push:
    tags:
      - "v*.*.*" # Triggered on version tags like v1.0.0
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: ghcr.io
  NODE_VERSION: "18"
  JAVA_VERSION: "17"

jobs:
  # Build and push Docker images
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    strategy:
      fail-fast: false
      matrix:
        include:
          - service: frontend
            context: ./frontend
          - service: api-gateway
            context: ./backend/api-gateway
          - service: auth-service
            context: ./backend/services/auth-service
          - service: user-service
            context: ./backend/services/user-service
          - service: chat-service
            context: ./backend/services/chat-service
          - service: media-service
            context: ./backend/services/media-service
          - service: story-service
            context: ./backend/services/story-service
          - service: notification-service
            context: ./backend/services/notification-service

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository_owner }}/chat-platform-${{ matrix.service }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

  # Deployment job (placeholder - customize based on your infrastructure)
  deploy:
    name: Deploy to ${{ github.event.inputs.environment || 'production' }}
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/v')
    environment: ${{ github.event.inputs.environment || 'production' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to environment
        run: |
          echo "ðŸš€ Deployment placeholder"
          echo "Environment: ${{ github.event.inputs.environment || 'production' }}"
          echo "Images have been built and pushed to ${{ env.REGISTRY }}"
          echo ""
          echo "Next steps:"
          echo "1. Update your deployment scripts to pull the new images"
          echo "2. Deploy using your infrastructure (Kubernetes, Docker Swarm, etc.)"
          echo "3. Run database migrations if needed"
          echo "4. Verify health checks"

          # Example: Deploy using docker-compose
          # docker compose -f docker-compose.prod.yml pull
          # docker compose -f docker-compose.prod.yml up -d

      - name: Summary
        run: |
          echo "## Deployment Summary ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment**: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All Docker images have been built and pushed to ${{ env.REGISTRY }}" >> $GITHUB_STEP_SUMMARY
